<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Chat</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh;}
    #log {flex: 1; overflow-y: auto; padding: 8px; background: #f5f5f5; white-space: pre-wrap;}
    #box {display: flex; padding: 8px; background: #ddd;}
    #msg {flex: 1; padding: 6px;}
    #snd {margin-left: 6px; padding: 6px 12px;}
  </style>
</head>
<div class="relative">
  <div id="join-modal" class="relative translate-x-full top-5 right-4 bg-green-400 opacity-0">
    <p id="message"></p>
  </div>
</div>
<body>
  <div id="log"></div>
  <div id="box">
    <input id="user" placeholder="Username" size="10">
    <input id="msg"  placeholder="Type messageâ€¦">
    <button id="snd">Send</button>
  </div>

  <script>
    const log = document.getElementById('log');
    const user = document.getElementById('user');
    const msg  = document.getElementById('msg');
    const snd  = document.getElementById('snd');

    function add(line){ log.textContent += line + '\n'; log.scrollTop = log.scrollHeight; }

    snd.onclick = async () => {
      const u = user.value || 'anon';
      const m = msg.value.trim();
      if(!m) return;
      await fetch('/send', {method:'POST', headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({username:u, text:m})});
      msg.value = '';
    };

    const joinModal = document.getElementById("join-modal");

    function showJoinModal(message){
        joinModal.getElementById("message").textContent = message? message : "New user Joined"
        joinModal.classList.remove("translate-x-full", "opacity-0")
        joinModal.classList.add("translate-x-0", "opacity-100")
    }
    
    function hideoinModal(){
        joinModal.classList.remove("translate-x-0", "opacity-100")

        joinModal.classList.add("translate-x-full", "opacity-0")
    }

    async function poll(){
      try{
        const r = await fetch('/poll');
        const j = await r.json();
        if(j.text) add(j.text);
        //console.log(j)
        showJoinModal(j.text)
        setTimeout(()=>{
          hideoinModal()
        }, 1000)
      }catch(e){}
      setTimeout(poll, 55000);   // poll every second
    }
    poll();
  </script>
</body>
</html>